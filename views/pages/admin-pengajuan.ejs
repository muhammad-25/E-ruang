<link rel="stylesheet" href="/css/admin-pengajuan.css">

<div class="pengajuan-container">
    
    <div class="pengajuan-card" id="menunggu">
        <h3>Menunggu Persetujuan</h3>
        <div class="table-responsive">
            <table class="custom-table">
                <thead>
                    <tr>
                        <th>NIM</th>
                        <th>Tanggal</th>
                        <th>Waktu</th>
                        <th>Nama Kelas</th>
                        <th>Status</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody>
                    <% const pending = bookings.filter(b => b.status === 'Menunggu'); %>
                    
                    <% if (pending.length > 0) { %>
                        <% pending.forEach(item => { %>
                        <tr>
                            <td><%= item.nim %></td>
                            <td><%= item.date %></td>
                            <td><%= item.time %></td>
                            <td><%= item.room %></td>
                            <td><span class="badge badge-menunggu">Menunggu</span></td>
                            <td>
                                <div class="btn-group">
                                    <button type="button" class="btn-action btn-detail" 
                                        onclick="openDetailModal(this)"
                                        data-nim="<%= item.nim %>"
                                        data-name="<%= item.requester_name %>"
                                        data-pj="<%= item.pj %>"
                                        data-room="<%= item.room %>"
                                        data-date="<%= item.date %>"
                                        data-time="<%= item.time %>"
                                        data-count="<%= item.count %>"
                                        data-desc="<%= item.desc %>">
                                        <i class="fa-solid fa-eye"></i> Detail
                                    </button>

                                    <button type="button" class="btn-action btn-blue" onclick="openEditModal('<%= item.id %>')">
                                        Proses
                                    </button>
                                </div>
                            </td>
                        </tr>
                        <% }) %>
                    
                    <% } else { %>
                        <tr class="empty-row">
                            <td colspan="6">Tidak ada pengajuan baru saat ini.</td>
                        </tr>
                    <% } %>
                </tbody>
            </table>
        </div>
    </div>

    <div class="pengajuan-card" id="disetujui">
        <h3>Disetujui</h3>
        <div class="table-responsive">
            <table class="custom-table">
                <thead>
                    <tr>
                        <th>NIM</th>
                        <th>Tanggal</th>
                        <th>Waktu</th>
                        <th>Nama Kelas</th>
                        <th>Status</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody>
                    <% const approved = bookings.filter(b => b.status === 'Disetujui'); %>
                    
                    <% if (approved.length > 0) { %>
                        <% approved.forEach(item => { %>
                        <tr>
                            <td><%= item.nim %></td>
                            <td><%= item.date %></td>
                            <td><%= item.time %></td>
                            <td><%= item.room %></td>
                            <td><span class="badge badge-setuju">Disetujui</span></td>
                            <td>
                                <button type="button" class="btn-action btn-blue" onclick="openEditModal('<%= item.id %>')">Edit</button>
                            </td>
                        </tr>
                        <% }) %>
                    <% } else { %>
                        <tr class="empty-row"><td colspan="6">Belum ada data disetujui.</td></tr>
                    <% } %>
                </tbody>
            </table>
        </div>
    </div>

    <div class="pengajuan-card" id="ditolak">
        <h3>Ditolak</h3>
        <div class="table-responsive">
            <table class="custom-table">
                <thead>
                    <tr>
                        <th>NIM</th>
                        <th>Tanggal</th>
                        <th>Waktu</th>
                        <th>Nama Kelas</th>
                        <th>Status</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody>
                    <% const rejected = bookings.filter(b => b.status === 'Ditolak'); %>
                    
                    <% if (rejected.length > 0) { %>
                        <% rejected.forEach(item => { %>
                        <tr>
                            <td><%= item.nim %></td>
                            <td><%= item.date %></td>
                            <td><%= item.time %></td>
                            <td><%= item.room %></td>
                            <td><span class="badge badge-tolak">Ditolak</span></td>
                            <td>
                                <button type="button" class="btn-action btn-blue" onclick="openEditModal('<%= item.id %>')">Edit</button>
                            </td>
                        </tr>
                        <% }) %>
                    <% } else { %>
                        <tr class="empty-row"><td colspan="6">Belum ada data ditolak.</td></tr>
                    <% } %>
                </tbody>
            </table>
        </div>
    </div>
</div>

</div> <div class="modal-overlay" id="editModal">
    <div class="modal-box">
        <button type="button" class="btn-close-modal" onclick="closeModal()">
            <i class="fa-solid fa-xmark"></i>
        </button>

        <div class="modal-icon">
            <i class="fa-solid fa-exclamation"></i>
        </div>

        <h3 class="modal-title">Edit Status</h3>

        <form id="formStatusUpdate" method="POST" action="/admin/booking/update">
            
            <input type="hidden" name="booking_id" id="modalBookingId">
            <input type="hidden" name="new_status" id="modalNewStatus">

            <div class="modal-actions">
                <button type="button" class="btn-modal btn-modal-setuju" onclick="submitStatus('Disetujui')">
                    Setuju
                </button>
                <button type="button" class="btn-modal btn-modal-tolak" onclick="submitStatus('Ditolak')">
                    Tolak
                </button>
            </div>
        </form>
    </div>
</div>
<div class="modal-overlay" id="detailModal">
    <div class="modal-box modal-lg"> <button type="button" class="btn-close-modal" onclick="closeDetailModal()">
            <i class="fa-solid fa-xmark"></i>
        </button>

        <div class="modal-header-left">
            <h3 class="modal-title">Detail Peminjaman</h3>
        </div>

        <div class="detail-content">
            <div class="detail-row">
                <span class="label">Peminjam (Akun):</span>
                <span class="value" id="d-name"></span>
            </div>
            <div class="detail-row">
                <span class="label">NIM:</span>
                <span class="value" id="d-nim"></span>
            </div>
            <div class="detail-row">
                <span class="label">Penanggung Jawab:</span>
                <span class="value highlight-text" id="d-pj"></span>
            </div>
            <hr class="divider">
            <div class="detail-row">
                <span class="label">Ruangan:</span>
                <span class="value" id="d-room"></span>
            </div>
            <div class="detail-row">
                <span class="label">Waktu:</span>
                <span class="value" id="d-datetime"></span>
            </div>
            <div class="detail-row">
                <span class="label">Jumlah Peserta:</span>
                <span class="value" id="d-count"></span>
            </div>
            <div class="detail-row full-width">
                <span class="label">Tujuan / Deskripsi:</span>
                <p class="value description-box" id="d-desc"></p>
            </div>
        </div>

        <div class="modal-actions" style="justify-content: flex-end;">
            <button type="button" class="btn-modal btn-modal-tolak" onclick="closeDetailModal()">Tutup</button>
        </div>
    </div>
</div>
<script>
    function openEditModal(bookingId) {
        document.getElementById('modalBookingId').value = bookingId;

        document.getElementById('editModal').classList.add('show');
    }

    function closeModal() {
        document.getElementById('editModal').classList.remove('show');
    }

    function submitStatus(status) {
        document.getElementById('modalNewStatus').value = status;
        document.getElementById('formStatusUpdate').submit();
    }


    function openDetailModal(button) {
        const nim = button.getAttribute('data-nim');
        const name = button.getAttribute('data-name');
        const pj = button.getAttribute('data-pj');
        const room = button.getAttribute('data-room');
        const date = button.getAttribute('data-date');
        const time = button.getAttribute('data-time');
        const count = button.getAttribute('data-count');
        const desc = button.getAttribute('data-desc');
        document.getElementById('d-nim').textContent = nim;
        document.getElementById('d-name').textContent = name;
        document.getElementById('d-pj').textContent = pj;
        document.getElementById('d-room').textContent = room;
        document.getElementById('d-datetime').textContent = date + ', Pukul ' + time;
        document.getElementById('d-count').textContent = count + ' Orang';
        document.getElementById('d-desc').textContent = desc;

        document.getElementById('detailModal').classList.add('show');
    }

    function closeDetailModal() {
        document.getElementById('detailModal').classList.remove('show');
    }
</script>